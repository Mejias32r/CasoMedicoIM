<div id="zAxis">
    <p>Z axis</p>

    <label for="classSelectZ">Class</label>
    <select id="classSelectZ" name="optionsZ" autocomplete="off">
        <option value="" disabled selected>Select class</option>
        <option value="TissueMetrics">TissueMetrics</option>
        <option value="Cerebrum">Cerebrum</option>
        <option value="Cerebellum">Cerebellum</option>
        <option value="LateralVentricles">LateralVentricles</option>
        <option value="Caudate">Caudate</option>
        <option value="Putamen">Putamen</option>
        <option value="GlobusPallidus">GlobusPallidus</option>
        <option value="Hippocampus">Hippocampus</option>
        <option value="Amygdala">Amygdala</option>
        <option value="Accumbens">Accumbens</option>
    </select>
    <p></p>
    <label for="valueSelectZ" autocomplete="off">Attributes</label>
    <select id="valueSelectZ" name="valuesZ"></select>
</div>

<select id="plotSelect" name="plot" autocomplete="off">
    <option value="" disabled selected>-</option>
    <option value="histogram">Histogram</option>
    <option value="bar">Bar chart</option>
    <option value="Line chart">Line chart</option>
    <option value="scatter">Scatter</option>
    <option value="scatter3d">3D Scatter</option>
    <option value="surface">3D Surface</option>
    <option value="mesh3d">3D Mesh</option>
    <option value="single-axis">Single Axis Plot</option> <!-- New option -->
</select>

<script>
plotSelect.addEventListener("change", function () {
    const yAxisContainer = document.getElementById("yAxis");
    const zAxisContainer = document.getElementById("zAxis");

    if (plotSelect.value === "histogram" || plotSelect.value === "single-axis") {
        // Hide Y-axis and Z-axis containers
        yAxisContainer.style.display = "none";
        zAxisContainer.style.display = "none";
    } else if (plotSelect.value === "scatter3d" || plotSelect.value === "surface" || plotSelect.value === "mesh3d") {
        // Show all axis containers for 3D plots
        yAxisContainer.style.display = "block";
        zAxisContainer.style.display = "block";
    } else {
        // Show only X and Y axes for 2D plots
        yAxisContainer.style.display = "block";
        zAxisContainer.style.display = "none";
    }
});

btnAdd.onclick = async function () {
    const plotType = document.getElementById("plotSelect").value;
    const classSelectX = document.getElementById("classSelectX").value;
    const valueSelectX = document.getElementById("valueSelectX").value;
    const classSelectY = document.getElementById("classSelectY").value;
    const valueSelectY = document.getElementById("valueSelectY").value;
    const classSelectZ = document.getElementById("classSelectZ")?.value;
    const valueSelectZ = document.getElementById("valueSelectZ")?.value;

    if (plotType === "scatter3d") {
        if (!classSelectX || !valueSelectX || !classSelectY || !valueSelectY || !classSelectZ || !valueSelectZ) {
            alert("Please select a class and attribute for all axes (X, Y, Z).");
            return;
        }
    } else if (plotType === "single-axis" || plotType === "histogram") {
        if (!classSelectX || !valueSelectX) {
            alert("Please select a class and attribute for the X axis.");
            return;
        }
    } else if (!plotType || !classSelectX || !valueSelectX || !classSelectY || !valueSelectY) {
        alert("Please select a plot type and all required fields.");
        return;
    }

    btnAdd.disabled = true;
    btnAdd.textContent = "Loading...";

    try {
        const data = await fetchGraphData();

        const chartWrapper = document.createElement("div");
        chartWrapper.className = "chart-container";
        const chartId = "chart_" + Date.now();
        chartWrapper.id = chartId;

        const closeButton = document.createElement("button");
        closeButton.className = "deletechartbtn";
        closeButton.textContent = "âœ–";
        closeButton.onclick = function () {
            chartWrapper.remove();
        };

        const chartDiv = document.createElement("div");
        chartDiv.id = chartId;

        chartWrapper.appendChild(closeButton);
        chartWrapper.appendChild(chartDiv);

        const parentContainer = document.getElementById("main");
        parentContainer.appendChild(chartWrapper);

        renderPlot(data.ejeX, data.ejeY, data.ejeZ, chartDiv.id, plotType);

        modal.style.display = "none";
    } catch (error) {
        console.error("Error fetching or plotting data:", error);
    }

    btnAdd.disabled = false;
    btnAdd.textContent = "Add";
};

function renderPlot(x, y, z, chartId, plotType) {
    let trace;

    if (plotType === "scatter3d") {
        trace = {
            x: x,
            y: y,
            z: z,
            mode: "markers",
            type: "scatter3d",
            marker: {
                size: 5,
                color: z,
                colorscale: "Viridis",
            },
        };
    } else if (plotType === "surface") {
        trace = {
            x: x,
            y: y,
            z: z, // z should be a 2D array for surface plots
            type: "surface",
            colorscale: "Viridis",
        };
    } else if (plotType === "mesh3d") {
        trace = {
            x: x,
            y: y,
            z: z,
            type: "mesh3d",
            color: "lightblue",
            opacity: 0.5,
        };
    } else if (plotType === "scatter") {
        trace = {
            x: x,
            y: y,
            mode: "markers",
            type: "scatter",
            marker: { color: "blue" },
        };
    } else if (plotType === "bar") {
        trace = {
            x: x,
            y: y,
            type: "bar",
            marker: { color: "green" },
        };
    } else if (plotType === "histogram" || plotType === "single-axis") {
        trace = {
            x: x,
            type: "histogram",
            marker: { color: "purple" },
        };
    } else if (plotType === "Line chart") {
        trace = {
            x: x,
            y: y,
            mode: "lines",
            type: "scatter",
            line: { color: "red" },
        };
    } else {
        console.error("Unsupported plot type:", plotType);
        return;
    }

    const xAxisLabel = document.getElementById("valueSelectX").value || "X";
    const yAxisLabel = document.getElementById("valueSelectY")?.value || "Y";

    const layout = {
        title: {
            text:
                plotType === "scatter3d" || plotType === "surface" || plotType === "mesh3d"
                    ? `3D Plot: ${xAxisLabel} vs ${yAxisLabel}`
                    : plotType === "single-axis" || plotType === "histogram"
                    ? `Single Axis Plot: ${xAxisLabel}`
                    : `Plot: ${xAxisLabel} vs ${yAxisLabel}`,
            font: {
                size: 16,
                color: "black",
            },
        },
        ...(plotType === "scatter3d" || plotType === "surface" || plotType === "mesh3d"
            ? {
                  scene: {
                      xaxis: { title: "X Axis" },
                      yaxis: { title: "Y Axis" },
                      zaxis: { title: "Z Axis" },
                  },
              }
            : {
                  xaxis: {
                      title: {
                          text: `X axis: ${xAxisLabel}`,
                          font: {
                              size: 14,
                              color: "black",
                          },
                      },
                  },
                  yaxis: plotType !== "single-axis" && plotType !== "histogram"
                      ? {
                            title: {
                                text: `Y axis: ${yAxisLabel}`,
                                font: {
                                    size: 14,
                                    color: "black",
                                },
                            },
                        }
                      : undefined,
              }),
    };

    const config = {
        responsive: true,
    };

    Plotly.newPlot(chartId, [trace], layout, config);
}
</script>